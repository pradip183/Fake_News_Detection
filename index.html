<!DOCTYPE html>
<html>
  <head>
    <title>Sign in Using MetaMask</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.1/dist/ethers.umd.min.js" type="application/javascript"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }

      h1 {
        margin-bottom: 20px;
      }

      p {
        text-align: center;
        font-size: 20px;
        margin-top: 50px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #3f51b5;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
      }

      button:hover {
        background-color: #1c2b46;
      }
    </style>
  </head>
  <body>
    <h1>Sign in Using MetaMask</h1>
    <button id="loginButton" onclick="signIn()">Sign In</button>
    <p id="p1"></p>

    <script>
      // Function to verify token with the Flask backend
      async function verifyToken(token) {
        try {
          const response = await fetch('/verify', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });
          const result = await response.json();
          return result === 'ok';
        } catch (error) {
          console.error('Error verifying token:', error);
          return false;
        }
      }

      // Sign-in logic triggered by clicking the Sign In button
      async function signIn() {
        const token = window.localStorage.getItem('token');
        
        // If a token is found in localStorage, verify it first
        if (token) {
          const isValid = await verifyToken(token);
          
          if (isValid) {
            // Token is valid, redirect to the success page
            window.location.href = '/success';
            return;
          } else {
            // If the token is invalid, show a message and continue with signing
            document.getElementById('p1').innerText = 'Session expired. Please sign in again.';
            window.localStorage.removeItem('token'); // Remove expired token
          }
        }

        // If no token or invalid, perform message signing for login
        signMessage();
      }

      // Function to handle signing the message if no valid token exists
      async function signMessage() {
        try {
          // Check if MetaMask (or any Ethereum provider) is available
          if (typeof window.ethereum === 'undefined') {
            alert('Please install MetaMask or another Ethereum wallet!');
            return;
          }

          // Request account access if MetaMask is locked or not connected
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          
          // Check if the account was successfully unlocked
          if (!accounts || accounts.length === 0) {
            alert('No accounts found. Please unlock your MetaMask wallet.');
            return;
          }

          // Get the provider and signer
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();

          // Get the user's address
          const address = await signer.getAddress();

          // Get the nonce value from the server (Flask backend)
          const nonce = await getNonce();

          // Create the message to sign
          const message = `I am signing this message to prove my identity. Nonce: ${nonce}`;

          // Sign the message with the user's account
          const signedMessage = await signer.signMessage(message);

          // Send the signed message, message, and address to the server (Flask)
          const data = { signedMessage, message, address };
          const response = await fetch('/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          if (!response.ok) {
            throw new Error('Login failed');
          }

          // Handle the response and token
          const { token } = await response.json();

          if (token) {
            window.localStorage.setItem('token', token);
            // Redirect to the success page after successful login
            window.location.href = '/success';
          } else {
            throw new Error('Invalid response from server');
          }
        } catch (error) {
          console.error('Error during signing:', error);
          document.getElementById('p1').innerText = 'Error during signing. Please try again.';
        }
      }

      // Get the nonce value from the backend Flask server
      async function getNonce() {
        try {
          const response = await fetch('/api/nonce');
          if (!response.ok) {
            throw new Error('Failed to fetch nonce');
          }
          const data = await response.json();
          return data.nonce;
        } catch (error) {
          console.error('Error fetching nonce:', error);
          document.getElementById('p1').innerText = 'Error fetching nonce.';
        }
      }
    </script>
  </body>
</html>